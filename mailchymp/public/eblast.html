<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Eblast – Mailchymp</title>
    <style>
      :root {
        --ink: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --orange: #ff7a00;
        --orange2: #ffb26b;
        --shadow: 0 14px 40px rgba(0, 0, 0, 0.1);
        --radius: 18px;
        --card: #fff;
        --bg1: #fff7ed;
        --bg2: #ffffff;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 20px;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        color: var(--ink);
        background:
          radial-gradient(1200px 600px at 0% 0%, var(--bg1), transparent 60%),
          radial-gradient(
            1000px 600px at 100% 0%,
            rgba(255, 122, 0, 0.14),
            transparent 55%
          ),
          linear-gradient(180deg, var(--bg2), #fff);
        min-height: 100vh;
      }
      .topbar {
        width: min(1200px, 100%);
        margin: 0 auto 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      .menu-left {
        display: flex;
        align-items: center;
        gap: 18px;
      }
      .logo {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        background: linear-gradient(135deg, var(--orange), var(--orange2));
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 900;
        box-shadow: 0 10px 20px rgba(255, 122, 0, 0.25);
      }
      .menu {
        display: flex;
        gap: 14px;
      }
      .menu a {
        text-decoration: none;
        font-size: 14px;
        font-weight: 800;
        color: #374151;
        padding: 8px 12px;
        border-radius: 10px;
      }
      .menu a:hover {
        background: rgba(255, 122, 0, 0.1);
        color: #7c2d12;
      }
      .menu a.active {
        background: linear-gradient(135deg, var(--orange), var(--orange2));
        color: #fff;
        box-shadow: 0 8px 18px rgba(255, 122, 0, 0.25);
      }
      .menu-right {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .mini {
        font-size: 12px;
        color: var(--muted);
        border: 1px solid var(--border);
        background: rgba(17, 24, 39, 0.02);
        padding: 8px 10px;
        border-radius: 999px;
        white-space: nowrap;
      }
      @media (max-width: 640px) {
        .menu {
          gap: 6px;
        }
        .menu a {
          font-size: 13px;
          padding: 7px 10px;
        }
      }

      .wrap {
        width: min(1200px, 100%);
        margin: 0 auto;
        display: grid;
        gap: 14px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
        align-items: start;
      }
      @media (max-width: 980px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 16px;
      }
      h2 {
        margin: 0 0 10px;
        font-size: 16px;
      }
      .muted {
        color: var(--muted);
        font-size: 12px;
        line-height: 1.5;
      }
      label {
        font-size: 12px;
        color: var(--muted);
        font-weight: 900;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        outline: none;
        font-size: 13px;
        background: #fff;
      }
      textarea {
        min-height: 260px;
        resize: vertical;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      input:focus,
      textarea:focus,
      select:focus {
        border-color: rgba(255, 122, 0, 0.45);
        box-shadow: 0 0 0 4px rgba(255, 122, 0, 0.12);
      }
      .row {
        display: grid;
        gap: 8px;
        margin: 10px 0;
      }
      .rowActions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }
      .btn {
        border: 0;
        border-radius: 12px;
        padding: 10px 12px;
        font-weight: 900;
        cursor: pointer;
        user-select: none;
        transition: transform 0.05s ease;
        background: #fff;
        border: 1px solid var(--border);
        color: var(--ink);
        font-size: 13px;
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn.primary {
        background: linear-gradient(135deg, var(--orange), var(--orange2));
        color: #fff;
        border: 0;
        box-shadow: 0 12px 22px rgba(255, 122, 0, 0.22);
      }
      .btn.danger {
        border: 1px solid rgba(239, 68, 68, 0.35);
        color: #7f1d1d;
      }
      .btn.small {
        padding: 9px 10px;
        border-radius: 10px;
        font-size: 12px;
      }
      .pill {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 10px 12px;
        background: rgba(17, 24, 39, 0.02);
        display: flex;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .previewWrap {
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
        background: #fff;
      }
      .previewHead {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        background: rgba(17, 24, 39, 0.02);
      }
      .previewFrame {
        width: 100%;
        min-height: 420px;
        border: 0;
        background: #fff;
      }
      .toast {
        position: fixed;
        top: 16px;
        right: 16px;
        z-index: 9999;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.35);
        color: #d1fae5;
        padding: 12px;
        border-radius: 14px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.25);
        display: none;
        max-width: min(380px, calc(100vw - 32px));
        backdrop-filter: blur(8px);
      }
      .toast.show {
        display: block;
      }
      .toast.bad {
        background: rgba(239, 68, 68, 0.12);
        border-color: rgba(239, 68, 68, 0.35);
        color: #fee2e2;
      }
      .toast .r {
        display: flex;
        gap: 10px;
        align-items: flex-start;
      }
      .toast .x {
        margin-left: auto;
        border: 0;
        background: transparent;
        color: inherit;
        font-weight: 900;
        cursor: pointer;
        font-size: 18px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      /* Nhẹ nhàng cho datetime input nằm cạnh nút */
      .dt {
        width: 220px;
        max-width: 100%;
      }
      @media (max-width: 520px) {
        .dt {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="menu-left">
        <div class="logo">M</div>
        <nav class="menu">
          <a href="eblast.html" class="active">Eblast</a>
          <a href="dashboard.html">Dashboard</a>
        </nav>
      </div>
      <div class="menu-right">
        <span class="mini" id="miniSession"></span>
        <span class="mini" id="miniGmail"></span>
        <button class="btn small danger" id="btnLogout" type="button">
          Logout
        </button>
      </div>
    </div>

    <div class="wrap">
      <section class="card">
        <div class="pill">
          <div>
            <div style="font-weight: 900">Gmail connection</div>
            <div class="muted" id="gmailStatusText">Checking…</div>
          </div>
          <div class="rowActions">
            <button class="btn" id="btnConnect" type="button">
              Connect Gmail
            </button>
            <button class="btn danger" id="btnDisconnect" type="button">
              Disconnect
            </button>
          </div>
        </div>
      </section>

      <div class="grid">
        <section class="card">
          <h2>Compose</h2>

          <div class="row">
            <label>Recipient List</label>
            <select id="listSelect">
              <option value="">-- Select a list --</option>
            </select>

            <div class="rowActions">
              <input id="newListName" placeholder="New list name (optional)" />
              <button class="btn small" id="btnCreateList" type="button">
                Create List
              </button>
            </div>

            <div class="rowActions">
              <input
                id="emailsInput"
                placeholder="Add emails: a@a.com, b@b.com, ..."
              />
              <button class="btn small" id="btnAddEmails" type="button">
                Add Emails
              </button>
            </div>
          </div>

          <div class="row">
            <label>Title</label>
            <input id="title" placeholder="Campaign title" />
          </div>
          <div class="row">
            <label>Subject</label>
            <input id="subject" placeholder="Email subject" />
          </div>
          <div class="row">
            <label>From name</label>
            <input id="fromName" placeholder="Your brand name" />
          </div>
          <div class="row">
            <label>Reply-to (optional)</label>
            <input id="replyTo" placeholder="reply@domain.com" />
          </div>

          <div class="row">
            <label>HTML</label>
            <textarea
              id="htmlInput"
              placeholder="Paste email HTML here..."
            ></textarea>
          </div>

          <!-- Giữ layout cũ: chỉ thêm New Draft + Schedule -->
          <div class="rowActions">
            <button class="btn" id="btnSaveDraft" type="button">
              Save Draft
            </button>

            <button class="btn" id="btnNewDraft" type="button">
              New Draft
            </button>

            <button class="btn primary" id="btnCreateCampaign" type="button">
              Create Campaign
            </button>

            <button class="btn primary" id="btnSendNow" type="button">
              Send Now (by List)
            </button>

            <!-- Schedule: datetime + button -->
            <input
              id="scheduleAt"
              class="dt"
              type="datetime-local"
              title="Schedule time"
            />
            <button class="btn primary" id="btnSchedule" type="button">
              Schedule
            </button>
          </div>

          <div class="row">
            <label>Campaign ID</label>
            <input
              id="campaignId"
              class="mono"
              placeholder="auto after create"
            />
          </div>

          <div class="muted" id="draftMeta">Draft: not saved yet</div>
          <div class="muted" id="scheduleMeta" style="margin-top: 6px"></div>
        </section>

        <section class="card">
          <h2>Live Preview</h2>
          <div class="previewWrap">
            <div class="previewHead">
              <div class="muted">Preview updates as you type</div>
              <div class="rowActions">
                <button class="btn small" id="btnPreviewRefresh" type="button">
                  Refresh
                </button>
                <button class="btn small" id="btnPreviewPop" type="button">
                  Open
                </button>
              </div>
            </div>
            <iframe
              id="previewFrame"
              class="previewFrame"
              sandbox="allow-same-origin"
            ></iframe>
          </div>
        </section>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite">
      <div class="r">
        <div id="toastText"></div>
        <button class="x" id="toastX" type="button">×</button>
      </div>
    </div>

    <script>
      const API = "http://127.0.0.1:3000";
      const toast = document.getElementById("toast"),
        toastText = document.getElementById("toastText"),
        toastX = document.getElementById("toastX");
      let toastTimer = null;
      function showToast(text, type = "ok", ms = 2500) {
        toastText.textContent = text;
        toast.classList.toggle("bad", type === "bad");
        toast.classList.add("show");
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => toast.classList.remove("show"), ms);
      }
      toastX.onclick = () => {
        toast.classList.remove("show");
        clearTimeout(toastTimer);
      };

      async function api(path, options = {}) {
        const r = await fetch(API + path, {
          ...options,
          headers: {
            "Content-Type": "application/json",
            ...(options.headers || {}),
          },
          credentials: "include",
        });
        const data = await r.json().catch(() => null);
        if (!r.ok) throw new Error(data?.message || `HTTP ${r.status}`);
        return data;
      }

      async function refreshMini() {
        const me = await api("/api/auth/me");
        if (!me.user) {
          location.href = "compose.html";
          return;
        }
        document.getElementById("miniSession").textContent =
          `Session: ${me.user.email}`;

        const st = await api("/api/gmail/status");
        document.getElementById("miniGmail").textContent = st.connected
          ? `Gmail: ${st.email}`
          : "Gmail: NOT_CONNECTED";
        renderGmailStatus(st);
      }

      document.getElementById("btnLogout").onclick = async () => {
        try {
          await api("/api/auth/logout", { method: "POST" });
          showToast("Logged out.", "ok", 1400);
          setTimeout(() => (location.href = "compose.html"), 600);
        } catch (e) {
          showToast(e.message || "Logout failed", "bad", 3000);
        }
      };

      const gmailStatusText = document.getElementById("gmailStatusText");
      const btnConnect = document.getElementById("btnConnect");
      const btnDisconnect = document.getElementById("btnDisconnect");
      function renderGmailStatus(st) {
        if (st.connected) {
          gmailStatusText.textContent = `Connected: ${st.email}`;
          btnConnect.disabled = true;
          btnDisconnect.disabled = false;
        } else {
          gmailStatusText.textContent = "Not connected";
          btnConnect.disabled = false;
          btnDisconnect.disabled = true;
        }
      }
      btnConnect.onclick = () =>
        (window.location.href = API + "/api/gmail/connect");
      btnDisconnect.onclick = async () => {
        try {
          await api("/api/gmail/disconnect", { method: "POST" });
          showToast("Disconnected.", "ok", 1400);
          await refreshMini();
        } catch (e) {
          showToast(e.message || "Disconnect failed", "bad", 3000);
        }
      };

      const titleEl = document.getElementById("title");
      const subjectEl = document.getElementById("subject");
      const fromNameEl = document.getElementById("fromName");
      const replyToEl = document.getElementById("replyTo");
      const htmlEl = document.getElementById("htmlInput");
      const campaignIdEl = document.getElementById("campaignId");
      const draftMetaEl = document.getElementById("draftMeta");
      const scheduleMetaEl = document.getElementById("scheduleMeta");
      const listSelect = document.getElementById("listSelect");
      const scheduleAtEl = document.getElementById("scheduleAt");

      const previewFrame = document.getElementById("previewFrame");
      function setPreview(html) {
        const doc =
          previewFrame.contentDocument || previewFrame.contentWindow.document;
        doc.open();
        doc.write(
          html ||
            "<div style='font-family:system-ui;padding:16px;color:#6b7280'>No HTML</div>",
        );
        doc.close();
      }
      function refreshPreview() {
        setPreview(htmlEl.value);
      }
      let previewTimer = null;
      htmlEl.addEventListener("input", () => {
        clearTimeout(previewTimer);
        previewTimer = setTimeout(refreshPreview, 150);
      });
      document.getElementById("btnPreviewRefresh").onclick = refreshPreview;
      document.getElementById("btnPreviewPop").onclick = () => {
        const w = window.open("", "_blank");
        w.document.open();
        w.document.write(htmlEl.value || "<div>No HTML</div>");
        w.document.close();
      };

      // ===== Draft local =====
      const DRAFT_KEY = "mailchymp:eblast:draft:v4";
      function loadDraft() {
        const raw = localStorage.getItem(DRAFT_KEY);
        if (!raw) return;
        try {
          const d = JSON.parse(raw);
          titleEl.value = d.title || "";
          subjectEl.value = d.subject || "";
          fromNameEl.value = d.from_name || "";
          replyToEl.value = d.reply_to || "";
          htmlEl.value = d.html || "";
          campaignIdEl.value = d.campaign_id || "";
          scheduleAtEl.value = d.schedule_at || "";
          draftMetaEl.textContent = d.saved_at
            ? `Draft saved at: ${new Date(d.saved_at).toLocaleString()}`
            : "Draft loaded";
          scheduleMetaEl.textContent = d.schedule_at
            ? `Schedule set: ${formatLocalDatetime(d.schedule_at)}`
            : "";
          refreshPreview();
        } catch {}
      }

      function saveDraftLocal() {
        const payload = {
          title: titleEl.value.trim(),
          subject: subjectEl.value.trim(),
          from_name: fromNameEl.value.trim(),
          reply_to: replyToEl.value.trim(),
          html: htmlEl.value,
          campaign_id: campaignIdEl.value.trim(),
          schedule_at: scheduleAtEl.value || "",
          saved_at: Date.now(),
        };
        localStorage.setItem(DRAFT_KEY, JSON.stringify(payload));
        draftMetaEl.textContent = `Draft saved at: ${new Date(payload.saved_at).toLocaleString()}`;
        scheduleMetaEl.textContent = payload.schedule_at
          ? `Schedule set: ${formatLocalDatetime(payload.schedule_at)}`
          : "";
      }

      document.getElementById("btnSaveDraft").onclick = () => {
        saveDraftLocal();
        showToast("Draft saved.", "ok", 1400);
      };

      let lastHash = "";
      function hashDraft() {
        return [
          titleEl.value,
          subjectEl.value,
          fromNameEl.value,
          replyToEl.value,
          htmlEl.value,
          campaignIdEl.value,
          scheduleAtEl.value,
        ].join("||");
      }

      setInterval(() => {
        const h = hashDraft();
        if (h !== lastHash) {
          lastHash = h;
          if (
            (
              titleEl.value +
              subjectEl.value +
              fromNameEl.value +
              htmlEl.value
            ).trim().length
          ) {
            saveDraftLocal();
          }
        }
      }, 8000);

      // ===== RESET after send/schedule =====
      function resetComposer({ keepList = true } = {}) {
        const currentList = listSelect.value;

        titleEl.value = "";
        subjectEl.value = "";
        fromNameEl.value = "";
        replyToEl.value = "";
        htmlEl.value = "";
        campaignIdEl.value = "";
        scheduleAtEl.value = "";
        draftMetaEl.textContent = "Draft: new";
        scheduleMetaEl.textContent = "";

        localStorage.removeItem(DRAFT_KEY);

        setPreview(
          "<div style='font-family:system-ui;padding:16px;color:#6b7280'>No HTML</div>",
        );

        if (keepList) listSelect.value = currentList;

        lastHash = "";
      }

      document.getElementById("btnNewDraft").onclick = () => {
        resetComposer({ keepList: true });
        showToast("New draft ready.", "ok", 1400);
      };

      // ===== Lists =====
      async function loadLists() {
        const res = await api("/api/lists");
        listSelect.innerHTML = `<option value="">-- Select a list --</option>`;
        res.lists.forEach((l) => {
          const opt = document.createElement("option");
          opt.value = l.id;
          opt.textContent = `${l.name} (${l.count} emails)`;
          listSelect.appendChild(opt);
        });
      }

      document.getElementById("btnCreateList").onclick = async () => {
        try {
          const name = document.getElementById("newListName").value.trim();
          if (!name) throw new Error("Missing list name");
          await api("/api/lists", {
            method: "POST",
            body: JSON.stringify({ name }),
          });
          showToast("List created.", "ok", 1500);
          document.getElementById("newListName").value = "";
          await loadLists();
        } catch (e) {
          showToast(e.message || "Create list failed", "bad", 3000);
        }
      };

      document.getElementById("btnAddEmails").onclick = async () => {
        try {
          const listId = listSelect.value;
          if (!listId) throw new Error("Please select a list first");
          const raw = document.getElementById("emailsInput").value;
          const emails = raw
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);
          if (!emails.length) throw new Error("No emails");
          const resp = await api(`/api/lists/${listId}/subscribers`, {
            method: "POST",
            body: JSON.stringify({ emails }),
          });
          showToast(`Added ${resp.added} email(s).`, "ok", 2000);
          document.getElementById("emailsInput").value = "";
          await loadLists();
        } catch (e) {
          showToast(e.message || "Add emails failed", "bad", 3200);
        }
      };

      // ===== Campaign create/send/schedule =====
      function requireFields() {
        const title = titleEl.value.trim(),
          subject = subjectEl.value.trim(),
          from_name = fromNameEl.value.trim(),
          html = htmlEl.value;
        if (!title) throw new Error("Missing title");
        if (!subject) throw new Error("Missing subject");
        if (!from_name) throw new Error("Missing from name");
        if (!html || !html.trim()) throw new Error("Missing html");
        return {
          title,
          subject,
          from_name,
          reply_to: replyToEl.value.trim(),
          html,
        };
      }

      async function createCampaignIfNeeded() {
        const existing = campaignIdEl.value.trim();
        if (existing) return Number(existing);
        const p = requireFields();
        const data = await api("/api/campaigns", {
          method: "POST",
          body: JSON.stringify({
            title: p.title,
            subject: p.subject,
            from_name: p.from_name,
            reply_to: p.reply_to,
            html: p.html,
          }),
        });
        campaignIdEl.value = String(data.campaign_id);
        showToast(`Created campaign ID: ${data.campaign_id}`, "ok", 2500);
        saveDraftLocal();
        return data.campaign_id;
      }

      document.getElementById("btnCreateCampaign").onclick = async () => {
        try {
          await createCampaignIfNeeded();
        } catch (e) {
          showToast(e.message || "Create failed", "bad", 3200);
        }
      };

      document.getElementById("btnSendNow").onclick = async () => {
        try {
          const st = await api("/api/gmail/status");
          if (!st.connected) throw new Error("Gmail not connected");

          const listId = listSelect.value;
          if (!listId) throw new Error("Please select a list");

          const campaignId = await createCampaignIfNeeded();

          const resp = await api("/api/campaigns/send", {
            method: "POST",
            body: JSON.stringify({
              campaign_id: campaignId,
              list_id: Number(listId),
            }),
          });

          showToast(
            `Send done. Sent: ${resp.sent} Failed: ${resp.failed}`,
            "ok",
            3500,
          );

          // NEW: reset after send
          resetComposer({ keepList: true });
        } catch (e) {
          showToast(e.message || "Send failed", "bad", 3500);
        }
      };

      // ===== Schedule helpers =====
      function formatLocalDatetime(val) {
        // val là datetime-local "YYYY-MM-DDTHH:mm"
        if (!val) return "";
        const d = new Date(val);
        if (isNaN(d.getTime())) return String(val);
        return d.toLocaleString();
      }

      function toIsoFromLocalInput(val) {
        // datetime-local là local time, đổi sang ISO để server hiểu thống nhất
        // Ví dụ: "2026-01-23T14:30" -> Date(local) -> ISO
        const d = new Date(val);
        if (isNaN(d.getTime())) return null;
        return d.toISOString();
      }

      document.getElementById("btnSchedule").onclick = async () => {
        try {
          const st = await api("/api/gmail/status");
          if (!st.connected) throw new Error("Gmail not connected");

          const listId = listSelect.value;
          if (!listId) throw new Error("Please select a list");

          const whenLocal = scheduleAtEl.value;
          if (!whenLocal) throw new Error("Please pick schedule time");

          const iso = toIsoFromLocalInput(whenLocal);
          if (!iso) throw new Error("Invalid schedule time");

          // Chặn hẹn giờ quá khứ
          if (new Date(iso).getTime() < Date.now() + 15 * 1000) {
            throw new Error("Schedule time must be in the future");
          }

          const campaignId = await createCampaignIfNeeded();

          // Backend cần có route này
          const resp = await api("/api/campaigns/schedule", {
            method: "POST",
            body: JSON.stringify({
              campaign_id: campaignId,
              list_id: Number(listId),
              scheduled_at: iso, // server lưu UTC
            }),
          });

          showToast(
            resp?.message || `Scheduled OK: ${formatLocalDatetime(whenLocal)}`,
            "ok",
            3500,
          );

          // NEW: reset after schedule
          resetComposer({ keepList: true });
        } catch (e) {
          showToast(e.message || "Schedule failed", "bad", 3500);
        }
      };

      // Set default schedule time = now + 30 minutes (cho tiện)
      function setDefaultScheduleTime() {
        const d = new Date(Date.now() + 30 * 60 * 1000);
        // datetime-local format: YYYY-MM-DDTHH:mm
        const pad = (n) => String(n).padStart(2, "0");
        const v =
          d.getFullYear() +
          "-" +
          pad(d.getMonth() + 1) +
          "-" +
          pad(d.getDate()) +
          "T" +
          pad(d.getHours()) +
          ":" +
          pad(d.getMinutes());
        if (!scheduleAtEl.value) scheduleAtEl.value = v;
      }

      window.addEventListener("load", async () => {
        loadDraft();
        refreshPreview();
        setDefaultScheduleTime();
        await refreshMini();
        await loadLists();
      });
    </script>
  </body>
</html>
